#! /usr/bin/env node

var app = require('commander');
var Logger = require('../lib/logger');
var paths = require('../lib/paths');
var create = require('../lib/commands/create');
var State = require('../lib/state');
var saveState = require('../lib/save-state');
var loadState = require('../lib/load-state');

app.option('-d --debug', 'Set the log level to debug');
app.option('-c --chdir <dir>', 'Change the current working directory');
app.parse(process.argv);

// Set the root dir
if (app.chdir) {
	process.chdir(app.chdir);
}

// Setup logger
var logger = Logger(app);
var cwd = process.cwd();
logger.debug('cwd: ' + cwd);

var mokrPaths = paths(cwd);

var name;
if (app.args.length === 1) {
	name = app.args[0];
} else {
	logger.error('Cannot create more than one fixture at a time.');
	process.exit(1);
}

create.createFixtureFile(cwd, name, function (err, fixturePath) {
	if (err) {
		logger.error(err);
	}

	logger.notice('Wrote fixture ' + fixturePath);
	create.createDataFile(cwd, name, function (err, dataPath) {
		if (err) {
			logger.error(err);
		}

		logger.notice('Wrote data file ' + dataPath);

		// Update the state file with the new fixture
		var state = new State();
		loadState(state, mokrPaths.stateFile, function (err) {
			if (err) {
				return logger.error(err);
			}
			saveState(state, mokrPaths.stateFile, function (err) {
				if (err) {
					return logger.error(err);
				}
				logger.notice('Fixture is ready to run: mokr up ' + name);
			});
		});
	});
});
