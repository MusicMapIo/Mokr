#! /usr/bin/env node

var app = require('commander');
var Logger = require('../lib/logger');
var chalk = require('chalk');
var paths = require('../lib/paths');
var State = require('../lib/state');
var loadState = require('../lib/load-state');

app.option('-d --debug', 'Set the log level to debug');
app.option('-c --chdir <dir>', 'Change the current working directory');
app.parse(process.argv);

// Set the root dir
if (app.chdir) {
	process.chdir(app.chdir);
}

// Setup logger
var logger = Logger(app);
var cwd = process.cwd();
logger.debug('cwd: ' + cwd);
logger.debug('force: ' + !!app.force);

var mokrPaths = paths(cwd);

// Load the state
var state = new State();
loadState(state, mokrPaths.stateFile, function (err) {
	if (err) {
		return logger.error(err);
	}

	logger.notice(chalk.white('\nFixture Status\n' + chalk.grey('=====================') + '\n'));

	if (!Object.keys(state.fixtures).length) {
		logger.notice('No fixtures setup yet.');
	}

	for (var i in state.fixtures) {
		logger.notice((state.fixtures[i].hasRun ? chalk.green('✔') : chalk.red('✘')) + '  ' + chalk.white.bold(i));
	}
});
